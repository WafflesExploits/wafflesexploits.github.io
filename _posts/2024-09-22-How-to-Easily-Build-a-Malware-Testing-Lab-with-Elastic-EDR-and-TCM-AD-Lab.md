---
title: "How to Easily Build a Malware Testing Lab with Elastic EDR and TCM's AD Lab"
date: 2024-09-12
categories: [Malware, Lab, Hacking, EDR Evasion, Red team, Penetration testing]
tags: [Malware, Lab, TCM, Evasion, EDR Evasion, Red team, Penetration testing]
description: "Learn how to easily create your own malware testing lab with a pre-configured Elastic EDR in Docker, integrated with TCM Security’s AD lab for malware evasion testing."
image: /assets/EDR_Malware_Lab_2.png
comments: true
---

## Table of Contents

1.  **[Introduction](#introduction)**
2.  **[Initial Lab](#initial-lab)**
    1.  **[Pre-requisites](#pre-requisites)**
    2.  **[Setting up the Domain Controller](#setting-up-the-domain-controller)**
        1.  **[Creating the Domain Controller VM](#creating-the-domain-controller-vm)**
        2.  **[Make this machine the Domain Controller](#make-this-machine-the-domain-controller)**
    3.  **[Setting up the User Machines](#setting-up-the-user-machines)**
    4.  **[Setting up Users, Groups, and Policies on the Domain Controller](#setting-up-users-groups-and-policies-on-the-domain-controller)**
    5.  **[Join User Machines to Domain](#join-user-machines-to-domain)**
3.  **[Adding Elastic EDR](#adding-elastic-edr)**
    1.  **[Installing Docker on Ubuntu](#installing-docker-on-ubuntu)**
    2.  **[Creating Elastic Container](#creating-elastic-container)**
    3.  **[All Elastic EDR container options](#all-elastic-edr-container-options)**
4.  **[Conclusion](#conclusion)**
5.  **[References](#references)**


## Introduction

**I wanted to test malware evasion techniques specifically against Elastic EDR, so I decided to build an Active Directory (AD) lab for this purpose.**

**In this blog post, I’ll guide you step-by-step on how to create your own malware testing environment.**

**We’ll containerize Elastic EDR using Docker, with a fully pre-configured setup that includes Elasticsearch, Kibana, Fleet, and the Detection Engine.**

**For the AD lab, we’ll use TCM Security’s Active Directory Lab as the foundation.**

## Initial Lab

**This section focuses on creating 3 VMs: 1 Domain Controller and 2 User Machines.**

**This initial lab is based entirely on TCM's Active Directory Lab from the [Practical Ethical Hacking Course](https://academy.tcm-sec.com/p/practical-ethical-hacking-the-complete-course). I highly recommend checking out their course.**

**However, you can use any lab environment you prefer, such as [GOAD](https://github.com/Orange-Cyberdefense/GOAD).**

1.  **[Pre-requisites](#pre-requisites)**
2.  **[Setting up the Domain Controller](#setting-up-the-domain-controller)**
    1.  **[Creating the Domain Controller VM](#creating-the-domain-controller-vm)**
    2.  **[Make this machine the Domain Controller](#make-this-machine-the-domain-controller)**
3.  **[Setting up the User Machines](#setting-up-the-user-machines)**
4.  **[Setting up Users, Groups, and Policies on the Domain Controller](#setting-up-users-groups-and-policies-on-the-domain-controller)**
5.  **[Join User Machines to Domain](#join-user-machines-to-domain)**

### Pre-requisites

**Recommended Specs:**

- **60 GB Disk Space.**
- **16 GB RAM.**

**Download necessary ISOs:**

- **[Windows Server 2022 ISO](https://www.microsoft.com/en-us/evalcenter/download-windows-server-2022).**
- **[Windows 11 Enterprise ISO](https://www.microsoft.com/en-us/evalcenter/download-windows-11-enterprise).**

**Download a virtualization software:**

- **VirtualBox.**
- **Hyper-V.**
- **VMware Workstation Pro.**
    - **I will use this one.**
    - **You can download it [here](https://softwareupdate.vmware.com/cds/vmw-desktop/ws/17.5.1/23298084/windows/core/).**
    - **I recommend the version 17.5.1 since it has more features than 17.6.**

### Setting up the Domain Controller

#### Creating the Domain Controller VM

1.  **After opening VMware, click on "Create a new Virtual Machine".**
2.  **Next, Select the configuration `Typical` and click `Next`.**
3.  **Select `Installer disc image file (iso)`, and select the `SERVER_EVAL_x64FRE_en-us` file you download.**
    - <img src="/assets/50c2ba5765a544629b79936dffd759c3.png" alt="b0b2f451839ce45047eb9941b3c5331f.png" width="235" height="51" >
4.  **Click `Next`, and you should see this window:**
    - <img src="/assets/64127b294ecf4cebbc68b6c9463c498a.png" alt="9d32511d8affbacac239afb10d2c29cf.png" width="149" height="105" >
5.  **We won't be using Easy Install, so click `Next`.**
6.  **You can use the default Disk options, and click `Next`.**
    - **<img src="/assets/163346d950884a5b9d364467a6ad5453.png" alt="277f8c4ab91ac09cba55147377628f0a.png" width="222" height="115" >**
7.  **Uncheck `"Power on this virtual machine after creation"`, and click `Finish`.**
    - **<img src="/assets/309ea4958fa4464284057d845abbb4c5.png" alt="7f0327af3ed26aa45c032fa809f9e5ec.png" width="297" height="196" >**
8.  **Click on `"Edit Virtual Machine Settings"`.**
9.  **Do the following:**
    - **Remove the Floppy disk:**
    - **<img src="/assets/79d658d3b49642d986f523cbeb54498b.png" alt="da83be80151024220679eced6fa4f34e.png" width="251" height="142" >**
    - **Change the memory to 4 GB Ram.**
    - **You can lower this down once you have finished the Setup.**
    - **Click `Okay` to exit from the Virtual Machine's settings.**
10. **Power the VM.**
11. **Press Enter 1-2 times and you should see this screen:**
    - **<img src="/assets/206135dc92e84688b431cd5317a7194f.png" alt="fa43e228d4583ec47c78ed75af723d07.png" width="274" height="202" >**
12. **Click `Next > Install`.**
13. **Select `"Windows 2022 Standard Evaluation (Desktop Experience)"`, and click `Next`.**
    - **<img src="/assets/f9e9daf16cb84e16bb9388ea1f6e3f2b.png" alt="9d22b97b7b28b6a57a556431162cfbc3.png" width="250" height="185" >**
14. **Accept the License terms, and click `Next`.**
15. **As the type of installation, Select `Custom`:**
    - **<img src="/assets/b6860f545f9d4fadba65e903b58deb98.png" alt="583defd9d553c703d9792fca22becb89.png" width="316" height="156" >**
16. **Click `New > Apply > Okay > Next`, and the Windows Server should start installing:**
    - **<img src="/assets/012daafbf6154dfabb06e62029979506.png" alt="01e50fcc1c71017d7505b94db36ead4c.png" width="259" height="126" >**
    - **<img src="/assets/400de22961864190a518130012f46250.png" alt="3bf17d77b929b999633e95e649116c70.png" width="257" height="191" >**
17. **While this installs, you can start installing the User Machines.**
18. **After the Server finishes installing, you should have the following screen:**
    - **<img src="/assets/fcb42b95e80e4e71bab68b01cecfb22f.png" alt="3da19e850014680df0d2b0768ec188c3.png" width="359" height="138" >**
    - **For the password, I will use `Pa$$w0rd!`.**
    - **Click `Next`, after you insert your password.**
19. **Now, you should be able to login with the password you just set.**
    - **Press CRTL+ALT+DEL to show the login screen.**
    - **With VMWare you can use this option:**
    - **<img src="/assets/cb16f427de0743eeaa0dc7c642e0dbb6.png" alt="2b3dbbb91fdf15957ae5ea62d55d0acf.png" width="179" height="152" >**
20. **If the screen is small, it's because you need to Install VMWare Tools.**
    - **On the VM, Select `VM > Install VMware Tools`.**
    - **<img src="/assets/25241c1709a34a449471fc120dba470f.png" alt="9931765d2aedbfee02ed24ffcfc55dea.png" width="178" height="154" >**
    - **Alternatively, you can directly download the VMware Tools package [here](https://softwareupdate.vmware.com/cds/vmw-desktop/ws/17.5.1/23298084/windows/packages/tools-windows.tar), extract the `.tar` with 7zip, and left-click the `.iso`.**
    - **Open `setup64`, click `Next` and `Install`.**
    - **<img src="/assets/ef17804184d9410ba35a4a8faac911b2.png" alt="a696b99aa75bfe4729ab98adacdb2b41.png" width="280" height="183" >**
    - **This should install VMware tools.**
21. **Rename your PC**
    1.  **Search for `"About your PC"` in the Windows Search bar.**
        - **<img src="/assets/badc596b7ca5497b824eeb96af665987.png" alt="cf10b7288e0221f435ea9e6ba8ee8360.png" width="150" height="88" >**
    2.  **Click on `Rename this PC`, choose a name, click `Next`, and click `Restart now`.**
        - **<img src="/assets/bd782166c7234646a8f964e13ddf5673.png" alt="c7108e11cdbd74fd616357d696fb8497.png" width="544" height="187" >**

#### Make this machine the Domain Controller

1.  **After logging in, In the Server Manager dashboard, Go to `Manage > Add Roles and Features`.**
    - <img src="/assets/f1aa1b80e5d8485a90d71b656ccdd0dd.png" alt="1dd0a8d9e2039a27be6230881917b513.png" width="511" height="78">
2.  **Click `Next` until the `Server Roles` section, check `"Active Directory Domain Services"` and click `Add Features`.**
    - **<img src="/assets/e17f6af2a8ce4fd0861365846da22bcd.png" alt="38c9607ca02ce34a0999325c1ac4d1b1.png" width="226" height="82" >**
    - **<img src="/assets/3a6932d8879046e5b62faf2c53f48281.png" alt="ca52d10c577fe32d99c1a51b0a7dbda1.png" width="170" height="164" >**
3.  **Click `Next` until the `Confirmation` section, check `"Restart the destination server automatically if required"`, select `Yes > Install`.**
    - **<img src="/assets/c637619416024c10960b92fadc9a51d1.png" alt="404b5e47cf58e8a5af77d1cbb40ea36d.png" width="447" height="175" >**
4.  **When the installation finishes, Select `Promote this server to a domain controller`.**
    - **<img src="/assets/d325acfe030049428dcde3ba0c2545a3.png" alt="6b4234f96843115ee1a32f8c4f53d026.png" width="304" height="111" >**
5.  **Select `Add a new forest`, choose a domain name, and click `Next`.**
    - **<img src="/assets/fc1d2a45b0b94926a5b6c9e543616644.png" alt="6194c1501bc41ca4c35b2855984658c9.png" width="342" height="133" >**
6.  **In the next window, select a DSRM Password and click `Next`.**
    - **I used `Pa$$w0rd!` again.**
    - **<img src="/assets/cc14f9f77173441fbb817aa125da0208.png" alt="f190c61d4bf98301a2d4b18f3b9b5923.png" width="352" height="74" >**
7.  **Click `Next` until `Prerequisites check`, and Click `Install`.**
8.  **After installation, click `Close` and restart the Domain Controller VM.**
9.  **After rebooting, In the Server Manager dashboard, Go to `Manage > Add Roles and Features`.**
10. **Click `Next` until the `Server Roles` section, check `"Active Directory Certificate Services"` and click `Add Features`.**
11. **Click `Next` until the `Role Services` section and check if `Certification Authority box` is check.**
12. **Click `Next` until `Confirmation` section, check `"Restart the destination server automatically if required"`, select `Yes > Install`.**
13. **When the installation finishes, Select `Configure Active Directory Certificate Services on the destination server`.**
    - **<img src="/assets/cac938e4087e436588416aae7951cbb7.png" alt="df21f0f637f8347660c4720337b2b429.png" width="283" height="85" >**
14. **Click `Next`. In the `Role Services` section check the `Certification Authority` box.**
15. **Click `Next` until `Validity Period` section, and set the Validity years to `99`.**
16. **Click `Next` until `Confirmation` section, click `Configure > Close`, and reboot your server.**

**Your Domain Server Initial Setup is finally finished! You can [setup the user machines](#setting-up-the-user-machines).**

### Setting up the User Machines

#### Creating the Users VMs

**This is almost identical to [Creating the Domain Controller VM](#creating-the-domain-controller-vm), the only difference are:**

1.  **Use the Windows 11 Enterprise Evaluation ISO:**
    - **<img src="/assets/ff4a1370f30847deb24878b2826c0f50.png" alt="94e6f33f06e05afdf928b82a3e22c5a7.png" width="372" height="39" >**
2.  **Use the Windows 11 Enterprise as the Version of installation.**
3.  **I will name the First machine "THEPUNISHER", and the Second machine "SPIDERMAN".**
4.  **VMware will ask you for the encryption type, select `Only the files needed to support a TPM are encrypted`.**
    - **I used `12345678` as the password.**
    - **<img src="/assets/d72021360e894174928e8289b5284189.png" alt="14ca204077e5fdc3e0271408c9889c6a.png" width="268" height="124" >**
5.  **After the installation finishes, select `Sign-in options > Domain join instead`.**
    - **This will allows us to create an Local Account.**
6.  **For the user name, I will use `frankcastle` for `THEPUNISHER`, and `peterparker` for `SPIDERMAN`.**
7.  **For the password, I will use `Password1` for `THEPUNISHER`, `Password2` for `SPIDERMAN`.**
8.  **For the security questions, I will use `bob` for everything.**
9.  **Rename the PCs to their VM Name respectively, `THEPUNISHER` and `SPIDERMAN`, and restart them.**

### Setting up Users, Groups, and Policies on the Domain Controller

1.  **Start the DC (Domain Controller) VM, and search for `Active Directory Users and Computers`, and open it.**
2.  **Right-click on `MARVEL.local` and select `New > Organizational Unit`.**
    - **<img src="/assets/54b2df1c23fa4ae58f73f1463c53777e.png" alt="c86a34f1a205359a684467ca40168f92.png" width="263" height="159" >**
3.  **Name it `"Groups"` and click `Okay`.**
4.  **Left-click on the `Users`, click on `Type` to organize users by type, select all Users that belong to the type `"Security Group"` and drag them to the OU (Organizational Unit) named Groups, that you just created.**
    - **<img src="/assets/5d51cbd07ae740c68f692183a8c431f7.png" alt="4e5b2860d5d93c9282a8ff706fb0459d.png" width="315" height="225" >**
5.  **Right-click on the Administrator user and select `Copy...`.**
    - **<img src="/assets/7b6f63cef6c647798126f6fd8f480d12.png" alt="667f6f6be9f7cfebe799c09cb64feb20.png" width="185" height="56" >**
6.  **Create the Tony Stark user:**
    - <img src="/assets/00d85bace0a749278d61cac373cdcc17.png" alt="78918d2d4e3b7aa755a39bf3d0066aba.png" width="235" height="205" >
    - <img src="/assets/840596f5da234a9e8af979ab09885474.png" alt="f1dd770344a86dbc7f716b6fc747edae.png" width="219" height="135" >
    - **Password: `Password12345!`**
    - **Check `Password never expires`.**
7.  **Create another user the same way you created Tony stark:**
    - **Full Name: SQL Service**
    - **User Logon: SQLService**
    - **Password: `MYpassword123#`**
    - **Check `Password never expires`.**
    - **After creating the user, right-click on him, select `Properties`, set its description to `"My password is MYpassword123#"`, and select `Apply > Okay`.**
8.  **Right-click on the Users, select `New > User`.**
    - **<img src="/assets/89a866ea865242199ee7517f7d9f915b.png" alt="469bbf648398431140308aeb33a0c027.png" width="238" height="155" >**
9.  **Create 2 users with this method:**
    - **First User:**
        - **Full Name: Frank Castle**
        - **User Logon: fcastle**
        - **Password: `Password1`**
        - **Check `Password never expires`.**
    - **Second User:**
        - **Full Name: Peter parker**
        - **User Logon: pparker**
        - **Password: `Password2`**
        - **Check `Password never expires`.**
10. **In the DC's Server manager, Go to `File and Storage Services > Shares > TASKS > New Share`.**
    - **<img src="/assets/a7688cd66f034e2e981e499ebb69c1d5.png" alt="fe895e8a21c7b1bcf2dc4ca80b03a720.png" width="162" height="136" >**
    - **<img src="/assets/cce781fb771e484aada1511a0689ea52.png" alt="6edbc0073ede98040fc2c936917420ab.png" width="286" height="89" >**
11. **In the New Share Wizard:**
    1.  **Select `SMB Share Quick`.**
    2.  **Click `Next` 2 times.**
    3.  **Set share name to `hackme`.**
    4.  **Click `Next` until `Confirmation`, and click `Create > Close`.**
12. **Open the `cmd.exe` on the DC, and run the following  commands:**
```
setspn -a HYDRA-DC/SQLService.MARVEL.local:60111 MARVEL\SQLService
```
13. **Check if the SQLService SPN is found:**
```
setspn -l SQLService
```
14. **Right-click the `Ethernet/WIFI` symbol and click on `Open Network & Internet Settings`.**
    
    - **<img src="/assets/a111b4790986495ea1c19eaf2e47d5ac.png" alt="af55aa0e26c0ac68f9fe7ef45db5fd76.png" width="210" height="88" >**
15. **On `Advanced Network` settings, select `Network and Sharing Center`.**
    
16. **On `active networks`, click on the `MARVEL.local` Connection.**
    
    - **In my case, it's `Ethernet0`.**
    - **<img src="/assets/63e813045fdd49108235c5bf472eebe6.png" alt="814bd1d4417d087c041e5ab1b49e2df2.png" width="263" height="58" >**
17. **Next, Go to `Properties > Internet Protocol Version 4 (TCP/IPv4)`.**
    
    - **<img src="/assets/5c6769539ed847158aff59e97b762653.png" alt="80ac61c7d3fcd5259888c9cb4a33739e.png" width="301" height="214" >**
        
    - **Open `cmd.exe`, run `ipconfig`, and copy the values from the command and use them in the IPv4 Properties, like so:**
        
        - <img src="/assets/34e11dfde69f4ee68e7e3d22dfb75196.png" alt="b55a2248fec423a5b038ff6ae4662b9d.png" width="433" height="141">
    - **On the IPv4 Properties, click `Okay > Okay > Close`.**
        
18. **Open any folder, go to the `Network` section, click the blue rectangle with `Click to Change...`, and choose `Turn on Network Discovery and File Sharing`:**
    
    - <img src="/assets/c4f6bcc76af94d8dad7d343d09bc7ec5.png" alt="baf310060dc521f0be2c1b944f3c6e94.png" width="238" height="189" >

**Now, you just need to make the [user machines join the Domain](#join-user-machines-to-domain).**

### Join User Machines to Domain

**The final step is to make the user machines join the `MARVEL.local` Domain.**

**Repeat the following steps for both User Machines:**

1.  **On the Windows search bar, Search for `Control Panel` and open it.**
2.  **Go to `Network and Internet > Network and Sharing Center`.**
3.  **On `active networks`, click on the `MARVEL.local` Connection.**
    - **In my case, it's `Ethernet0`.**
    - **<img src="/assets/63e813045fdd49108235c5bf472eebe6.png" alt="814bd1d4417d087c041e5ab1b49e2df2.png" width="263" height="58" >**
4.  **Next, Go to `Properties > Internet Protocol Version 4 (TCP/IPv4)`.**
5.  **For the DNS server address, we will use the IPv4 from the DC :**
    - **You can get this by running `ipconfig` on `cmd.exe` on the DC.**
    - **<img src="/assets/3890e38c608044118243003e4f9acb61.png" alt="cae57c04807316fa931c2d28813f62c7.png" width="181" height="205" >**
6.  **Click `Ok > Ok > Close`.**
7.  **In the Windows Search Bar, Search for `Access Work or School` and open it.**
8.  **On this new window, Click on `Connect`**
    - **<img src="/assets/9ff51833968c4514939212870a8e173d.png" alt="fc652d571b1f124427b3605954257198.png" width="287" height="51" >**
9.  **Select `Join this device to a local Active Directory Domain`.**
    - **<img src="/assets/108c39ef358747dc8efd6326eb56059b.png" alt="68cc9925b765a938473772a089e705a0.png" width="187" height="225" >**
10. **Enter the name of your domain in the new window, click `Next`, and log in with the Administrator account:**
    - **<img src="/assets/1a5168cb07fb48b2a96f3cbca5752719.png" alt="cee3af2ea2b0b3b498366bfb5c02012f.png" width="165" height="90" >**
    - **<img src="/assets/5ac968f53ad6427b8c05e35846a6c540.png" alt="1cc899feb53a79e4ca4288ee39140bc8.png" width="126" height="75" >**
11. **As the `Account type`, select `Administrator`.**
    - **<img src="/assets/f3e36d5f9a1e4e2cbc557fd631a820b9.png" alt="baba590e2f1c7c6a3ea8b236d03e6a8a.png" width="192" height="163" >**
12. **Click `Next > Restart Now`.**
13. **In the Windows search bar, Search for `Edit local users and groups` and open it:**
    - **<img src="/assets/a26e2a4efcd84404b03ecd073417c134.png" alt="20edc9d47ec5ae866c7b3fffcfbb1596.png" width="204" height="131" >**
14. **In this new window, Left-click `Users`, Right-Click `Administrator` and Select `Set Password > Proceed`.**
    - **<img src="/assets/bbc9957a92ec49448da46d1493c950e4.png" alt="5450c5614ee936bcba31741a8f0dc884.png" width="341" height="71" >**
15. **Set the Administrator password to `Password1!`.**
16. **Only on the `SPIDERMAN` machine, Go to `Groups`, double left-click `Administrators` group, and click `Add`.**
    - **Enter `fcastle` and click `Ok > Apply > Ok`.**
    - <img src="/assets/bbc9957a92ec49448da46d1493c950e4.png" alt="5450c5614ee936bcba31741a8f0dc884.png" width="341" height="71">
    - **This allows you to login into the `SPIDERMAN` machine using the `fcastle` user, enabling lateral movement for practice**
17. **Open any folder, go to the `Network` section, click the blue rectangle with `Click to Change...`, and choose `Turn on Network Discovery and File Sharing`:**
    - <img src="/assets/c4f6bcc76af94d8dad7d343d09bc7ec5.png" alt="baf310060dc521f0be2c1b944f3c6e94.png" width="238" height="189" >
18. **Only on the `SPIDERMAN` machine, Open any folder, go to the `This PC` section, click on the 3 dots, and select `Map network drive`.**
    - **<img src="/assets/aa55813d9992487ea166e1f662bd75e6.png" alt="711ea438e3597f2683ebbab4e3dc9653.png" width="258" height="189" >**
19. **In this new window, write `\\HYDRA-DC\hackme` in the folder name, check `Connect using different credentials`, and click `finish`.**
    - **<img src="/assets/8d1a6417a55f43de9e0b57689b75bd7d.png" alt="60d5159b2a1c399e4ac24908a5295f5e.png" width="312" height="154" >**
20. **Login using the DC's Administrator account, and `check Remember my credentials`:**
    - <img src="/assets/4e0b65f8df784145b7ed1262414b1773.png" alt="38e8a6c9e5aef066e93f7cda4e39d0c6.png" width="166" height="153" >
21. **Now, you should have access to the `hackme` share as Administrator:**
    - <img src="/assets/5f39354b5b33437f8fd88dbf19bc38d8.png" alt="f8f4971e3b7d30fd419a8aa282a86ddb.png" width="228" height="124" >

**Great job! You've successfully built the foundation of our lab.**

**Now, all that's left is to [add Elastic EDR](#adding-elastic-edr), and your lab setup will be complete!**

## Adding Elastic EDR

**This section will teach you how to add Elastic EDR to any machine using [peasead's elastic-container](https://github.com/peasead/elastic-container).**

**You will need Docker to run Elastic EDR. You can run Docker either in a virtual machine (VM) or directly on your host OS. I'll be using a Ubuntu VM in this guide.**

1.  **[Installing Docker on Ubuntu](#installing-docker-on-ubuntu)**
2.  **[Creating Elastic Container](#creating-elastic-container)**
3.  **[All Elastic EDR container options](#all-elastic-edr-container-options)**

### Installing Docker on Ubuntu

1\.  **Set up Docker's `apt` repository.**

```
# Add Docker's official GPG key:
sudo apt-get update
sudo apt-get install ca-certificates curl
sudo install -m 0755 -d /etc/apt/keyrings
sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
sudo chmod a+r /etc/apt/keyrings/docker.asc

# Add the repository to Apt sources:
echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
sudo apt-get update
```

2\.  **Install Docker's packages.**

```
sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
```

3\.  **Verify that the installation is successful by running the `hello-world` image:**

```
sudo docker run hello-world
```

4\.  **Optional, Grant the `docker` right to the default user.**

```
sudo groupadd docker
sudo usermod -aG docker $USER
```

### Creating Elastic Container

1\.  **Install elastic container pre-requisites:**

```bash
sudo apt-get install jq git curl
```

2\.  **Clone the Git repository and navigate to the Elastic container directory:**

```bash
git clone https://github.com/peasead/elastic-container.git
cd elastic-container
```

3\.  **Edit the file `.env` and change the following settings:**

```
ELASTIC_PASSWORD="changeme"
KIBANA_PASSWORD="changeme"
WindowsDR=1
LICENSE=trial # enable 30-day free trial with the platinum features (EDR)
```

4\.  **Run `elastic-container.sh`.**

```
chmod +x ./elastic-container.sh
sudo ./elastic-container.sh start
```

5\.  **Click on the 3 horizontal lines, scroll down, and click on `Fleet`.**

- <img src="/assets/5ead1c8e225c45fc8268866317530a0a.png" alt="f4eb1b92bd1aed2dda843a48c5ade678.png" width="127" height="166" >

6\.  **Select `Add agent`.**
    
- <img src="/assets/ea0fbe25a58a452ca9601bddcbcf3a5b.png" alt="136c8c136331b5d6cd49e34d63c50367.png" width="452" height="79">

7\.  **Scroll down to `Install Elastic Agent on your Host`, select `Windows` and copy the PowerShell script.**
    
- **<img src="/assets/b0bd05b2753e44d784cfc80b8df20068.png" alt="1955eef6fe48a9d45be6908967e34003.png" width="251" height="149" >**

8\.  **Now, go to each machine from the AD Lab, and** **follow these steps:**
    
-  **Copy the URL from the PowerShell script and paste it into your browser to download the .zip file faster.**
    - **<img src="/assets/8d7b349a13ed4344a85d408d274b4618.png" alt="2da87a8f0f7690946b8e9635af831a69.png" width="528" height="46" >**
-  **Once downloaded, extract the contents of the `.zip` file.**
-  **Run `elastic-agent.exe` using the arguments provided in the PowerShell script.**
- **If you encounter a certificate trust error, add the `--insecure` flag to solve it.**

9\.  **Now, you should see your machines in the Fleet section of Elastic EDR:**
    
- <img src="/assets/dc4f9ecab32f469e9687236350d945de.png" alt="9d5747d4e5cc9a5c720fa2d413034eed.png" width="474" height="127" >

### All Elastic EDR container options

```
# Start
./elastic-container.sh start
# Destroy Containers
./elastic-container.sh destroy
# Stop
./elastic-container.sh stop
# Restart
./elastic-container.sh restart
# Status
./elastic-container.sh status
# Clear all logs
./elastic-container.sh clear
```

## Conclusion

**Congratulations! You now have your own fully functional malware lab with Elastic EDR.**

**I hope this guide was helpful and easy to follow. If you have any questions, feel free to leave a comment or reach out to me directly.**

**Happy hacking! :)**

## References

- **[swisskyrepo's Elastic EDR Post](https://swisskyrepo.github.io/InternalAllTheThings/redteam/evasion/elastic-edr/)**
- **[TCM Security's Ethical Hacking Course](https://academy.tcm-sec.com/p/practical-ethical-hacking-the-complete-course)**
- **[peasead's elastic-container](https://github.com/peasead/elastic-container)**
