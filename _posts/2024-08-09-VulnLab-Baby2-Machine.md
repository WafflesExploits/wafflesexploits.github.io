---
title: "VulnLab - Baby2 (Machine)"
date: 2024-08-09
categories: [Write-up, VulnLab, Machine, CTF]
tags: [write-up, walkthrough, VulnLab, VulnLab, CTF, AD Pentest, ACL,VBS,PowerShell,Active Directory, Hacking]
description: Write-up for VulnLab's Baby2 (Machine).
image: /assets/baby2_logo.png
comments: true
---
### Table of Contents

1.  **[Info](#info)**
2.  **[Description](#description)**
3.  **[Nmap](#nmap)**
4.  **[Initial Compromise](#initial-compromise)**
    1.  **[Password spray](#password-spray)**
    2.  **[Reverse shell via login.vbs](#reverse-shell-via-loginvbs)**
5.  **[Privilege Escalation](#privilege-escalation)**
    1.  **[User group has WriteDACL rights on GPO Admin](#user-group-has-writedacl-rights-on-gpo-admin)**
    2.  **[Create Malicious GPO to escalate privileges](#create-malicious-gpo-to-escalate-privileges)**

### Info

**Machine Name:** Baby2

**Type:** Active Directory CTF

**Difficulty:** Medium

**Link to Wiki:** [VulnLabs Baby2 Wiki](https://wiki.vulnlab.com/guidance/medium/baby2)

### Description
- **Initial Access:** Use an exposed SMB share to create a username wordlist and perform password spraying.
- **First Reverse Shell:** Modify the Domain Login Script to gain a reverse shell.
- **Privilege Escalation:** Abuse DACLs and Group Policy Objects (GPOs) to elevate privileges.

### Nmap

I used Nmap to scan for open ports using the command below:

```bash
export ip=10.10.140.85-86
ports=$(sudo nmap -sS -p- --min-rate=1000 -T4 $ip -o nmap-alltcp.txt | grep -oP "^\d+" | tr "\n" "," | sed 's/,$//');sudo nmap -sS -sV -sC -O -T4 $ip -p$ports | grep -vP "closed|filtered" > nmap-enum.txt
```

```
Nmap scan report for 10.10.117.94
Host is up (0.038s latency).

PORT      STATE SERVICE       VERSION
53/tcp    open  domain?
| fingerprint-strings: 
|   DNSVersionBindReqTCP: 
|     version
|_    bind
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: baby2.vl0., Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=dc.baby2.vl
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::<unsupported>, DNS:dc.baby2.vl
| Not valid before: 2023-08-22T17:39:15
|_Not valid after:  2024-08-21T17:39:15
|_ssl-date: 2024-06-27T14:19:20+00:00; 0s from scanner time.
3389/tcp  open  ms-wbt-server Microsoft Terminal Services
| rdp-ntlm-info: 
|   Target_Name: BABY2
|   NetBIOS_Domain_Name: BABY2
|   NetBIOS_Computer_Name: DC
|   DNS_Domain_Name: baby2.vl
|   DNS_Computer_Name: dc.baby2.vl
|   DNS_Tree_Name: baby2.vl
|   Product_Version: 10.0.20348
|_  System_Time: 2024-06-27T14:18:40+00:00
| ssl-cert: Subject: commonName=dc.baby2.vl
| Not valid before: 2024-06-26T14:12:24
|_Not valid after:  2024-12-26T14:12:24
|_ssl-date: 2024-06-27T14:19:20+00:00; 0s from scanner time.
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
9389/tcp  open  mc-nmf        .NET Message Framing
49667/tcp open  msrpc         Microsoft Windows RPC
49668/tcp open  msrpc         Microsoft Windows RPC
49669/tcp open  msrpc         Microsoft Windows RPC
49671/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49675/tcp open  msrpc         Microsoft Windows RPC
61367/tcp open  msrpc         Microsoft Windows RPC
61375/tcp open  msrpc         Microsoft Windows RPC
61390/tcp open  msrpc         Microsoft Windows RPC
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port53-TCP:V=7.80%I=7%D=6/27%Time=667D7439%P=x86_64-pc-linux-gnu%r(DNSV
SF:ersionBindReqTCP,20,"\0\x1e\0\x06\x81\x04\0\x01\0\0\0\0\0\0\x07version\
SF:x04bind\0\0\x10\0\x03");
Device type: general purpose
Running (JUST GUESSING): Microsoft Windows 2016 (85%)
OS CPE: cpe:/o:microsoft:windows_server_2016
Aggressive OS guesses: Microsoft Windows Server 2016 (85%)
No exact OS matches for host (test conditions non-ideal).
Service Info: Host: DC; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode: 
|   2.02: 
|_    Message signing enabled and required
| smb2-time: 
|   date: 2024-06-27T14:18:42
|_  start_date: N/A

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
```

### Initial Compromise

#### Password spray

The SMB Share `"homes"` allows Guest users to read and write:

- <img src="/assets/ae12559294834ea3976680c7f16a9606.png" alt="007b53411ada3c32077a75aa69dbfb20.png" width="423" height="112" >

Inside the `"homes"` share, we get a list of all the users.

```bash
smbclient --no-pass //10.10.117.94/homes
```

- <img src="/assets/11d67aa204ff45c5a9d0a634981ebc52.png" alt="1a5a2797766b298d3f83aa47af273b2f.png" width="399" height="164" >

We can use this list of users to create a username wordlist, and password spray each account by using the username as password:

- <img src="/assets/276ce5083a91447c851602b655eaf5c2.png" alt="8eacce5301aff35aa3dab999c504afff.png" width="551" height="222" >

This gave us access to the users: `Carl.Moore`, `library`.

- <img src="/assets/2d71cffd9660433595191f06456827a2.png" alt="b46e2a879320cc70bbd600279b13e40b.png" width="536" height="153" >

#### Reverse shell via login.vbs

The accounts from before have permission to modify the `login.vbs` script, which is located in the SYSVOL share at `/baby.vl/scripts`.

This `login.vbs` is a Domain Logon Script, and is normally created in Active Directory Environments to run scripts when a user logins, just as its name suggests.

We can exploit this by altering the contents of `login.vbs` to a VBS script that downloads and executes in memory a reverse PowerShell shell.

- <img src="/assets/6656930421b6469ea538f810d5672ca5.png" alt="1549de0e66fe39cc4d61315a5861b5c5.png" width="533" height="81" >
- <img src="/assets/1501fa2fda44465295efdc62241f3aa7.png" alt="d6f2eb6b955803e815075335040a1207.png" width="565" height="53" >
- <img src="/assets/4f367c5932a14667932764bcf4dbefd0.png" alt="8457bec8d2d7f4aeb852e5d5596af30f.png" width="503" height="67" >

With this we got our first shell, and access to the user `amelia.griffiths`.

- <img src="/assets/e8025ff934e9453ab397b9e82353cb67.png" alt="ae7e5bed030e71d5f6366731e1bde72a.png" width="388" height="150" >

The user flag can be found in Amelia's Desktop folder.

### Privilege Escalation

#### User group has WriteDACL rights on GPO Admin

By running PowerView's `Invoke-AclScanner`, we can see any user belonging to the Legacy group, has WriteDACL rights on the GPO Admin.

- <img src="/assets/8a782f3903a5485daf415fc317b50814.png" alt="" width="418" height="229" >
- <img src="/assets/f4d04ec4a3e746b0b86d764d70a3e67a.png" alt="" width="376" height="255" >

`amelia.griffiths` belongs to the legacy group, so we can exploit this by changing GPO Admin's password:

- <img src="/assets/e527f375d600424789142c39b0d3cbed.png" alt="f256b3bec64058d33b6696fbcd474353.png" width="523" height="27" >
- <img src="/assets/5a44d51ee8d94370a9dde65f7a2a157b.png" alt="2a82b0a39fa0050f0f0abae96febd2f9.png" width="285" height="41" >

#### Create Malicious GPO to escalate privileges

If we run bloodhound, it suggests a Domain Privilege escalation path by using `pyGPOAbuse.py`.

- <img src="/assets/dd5beaebc50b44b09ddf0d29570e0f0c.png" alt="0f1f2fca5753d3de5eb83ce4623be42d.png" width="326" height="208" >

Since, we now have full control over the GPO Admin, we can use this to create an evil policy that will schedule task to add `gpoadm` to the administrators local group administrator.

- <img src="/assets/e79ad906e72043589569dd4be8c66d3b.png" alt="e771765b932b0c6290926cf481cf031f.png" width="550" height="60" >

We can now use a Pass the Pass technique, e.g. via Impacket's `psexec.py`, to login as `gpoadm` and grab the root flag, which is located at the Administrators folder.

- <img src="/assets/a2e02ef87dc940a1ba38b415ea552c04.png" alt="2281177a06e72ef9d8dff96ba560b3c4.png" width="347" height="217" >